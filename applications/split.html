
<html lang="ja">
	<head>
		<title>立替精算機 | だむめも</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="color-scheme" content="light dark">
		<link rel="stylesheet" href="/resources/main.css" />
		<link rel="stylesheet" href="/resources/layout.css" />
		<style>
			/*CALCULATOR*/
			/*MEMBER, ITEM*/
			.row{
				display: flex;
				padding: var(--gap);
				align-items: center;
				justify-content: space-between;
			}
			.row *:not(:last-child){
				margin-right: var(--gap);
			}
			/*INPUT DESIGN*/
			.name{
				min-width: 5em;
				height: var(--height);
				flex-grow: 3;
			}
			.price{
				min-width: 4em;
				max-width: 6em;
				height: var(--height);
				flex-grow: 1;
			}
			.select-list{
				width: 8em;
				height: var(--height);
				flex-grow: 1;
			}
			/*BUTTONS WRAPPER*/
			.buttons{
				display: flex;
				padding: var(--gap);
				align-items: center;
				justify-content: space-between;
			}
			/*BUTTON DESIGN*/
			.rmv, .add{
				display: block;
				position: relative;
				width: var(--height);
				height: var(--height);
				flex-grow: 0;
				flex-shrink: 0;
			}
			.rmv:hover,.add:hover{
				background: var(--color3);
				border-color: var(--color3);
			}
			.rmv::before, .add::before, 
			.rmv::after, .add::after{
				content: "";
				position: absolute;
				top: 50%;
				left: 50%;
				width: 3px;
				height: 80%;
				background: var(--color1);
				border-radius: var(--radius);
			}
			.rmv::before{
				transform:  translate(-50%,-50%) rotate(45deg);
			}
			.rmv::after{
				transform: translate(-50%,-50%) rotate(-45deg);
			}
			.add::before{
				transform: translate(-50%,-50%) rotate(180deg);
			}
			.add::after{
				transform: translate(-50%,-50%) rotate(90deg);
			}
			.rmv:hover::before, .add:hover::before, 
			.rmv:hover::after, .add:hover::after, 
			.rmv:focus::before, .add:focus::before, 
			.rmv:focus::after, .add:focus::after{
				background: var(--color2);
			}
			.submit{
				height: var(--height);
				padding: 0 8px;
				background: var(--color1);
				color: var(--color2);
				text-align: center;
			}
			.submit:hover, .submit:focus{
				background: var(--color3);
				color: var(--color1);
				border-color: var(--color3);
			}
			/*PAYER*/
			.payer-field p{
				padding: 0 var(--gap);
				text-indent: 0;
				text-align: justify;
			}
			.payer-div{
				width: 100%;
				padding: var(--gap);
				border-radius: var(--radius);
				overflow: hidden;
			}
			.payer-table{
				display: block;
				border-spacing: 0 2px;
				overflow-x: auto;
			}
			.payer-table th, .payer-table td{
				padding: 4px;
				text-align: center;
				border-right: 2px solid var(--color2);
			}
			.payer-table th{
				min-width:5em;
				max-width:8em;
				background: var(--color1);
				color: var(--color2);
				word-break: break-all;
			}
			.payer-table th:first-child{
				position: sticky;
				left: 0;
				top: 0;
				min-width: 7em;
				z-index: 1;
			}
			/*RESULT*/
			.result-math{
				border-bottom: 3px dotted var(--color1);
				border-radius: 0;
			}
			.result-digit, .radio-label{
				height: var(--height);
			}
			.result-list{
				padding: var(--gap);
			}
			.result-list, .result-list ul{
				padding-left: 12px;
				list-style-type: none;
			}
			/*SHARE*/
			.share{
				display: block;
				margin: 0 auto;
				padding: var(--gap) calc(var(--gap) * 3);
				background: var(--color2);
				color: var(--color1);
			}
			.share:hover, .share:focus{
				background: var(--color3);
			}
			.copy-text{
				all: unset;
				width: 90%;
				height: 30vh;
				padding: calc( var(--gap) * 2);
				color: var(--color1);
				background: transparent;
				border: 3px solid var(--color1);
				border-radius: var(--radius);
			}
			.copy-button{
				margin-top: var(--gap);
				color: var(--color1);
			}
			.copy-button:hover, .copy-button:focus{
				background: var(--color3);
				border-color: var(--color3);
			}
		</style>
		<script src="/resources/theme.js" async></script>
		<script src="/resources/option.js" async></script>
	</head>
	<body>
		<header class="header">
			<h2 class="blog-title"><a href="/" class="title-link">だむめも</a></h2>
			<nav id="headerNav" class="header-nav"></nav>
		</header>
		<main class="main">
			<article class="article">
				<h1 class="main-title">立替精算機</h1>
				<form id="splitForm" class="split-form" name="splitForm" onsubmit="event.preventDefault();">
					<fieldset class="member-field" name="memberField">
						<legend>メンバー</legend>
						<div id="memberForm" class="member-form"></div>
						<div class="buttons">
							<button type="button" class="add" name="memberAdd" onclick="addMember();"></button>
							<button type="button" class="submit" name="memberSubmit" onclick="editMember();">決定</button>
						</div>
					</fieldset>
					<fieldset class="item-field" name="itemField">
						<legend>立替費目</legend>
						<div id="itemForm"></div>
						<div class="buttons">
							<button type="button" class="add" name="itemAdd" onclick="addItem();"></button>
							<button type="button" class="submit" name="itemSubmit" onclick="editItem();">決定</button>
						</div>
					</fieldset>
					<fieldset class="payer-field" name="payerField" onchange="editPayer();">
						<legend>支払者</legend>
						<p>それぞれの費目について、割り勘に参加しない人のチェックを外してください。</p>
						<div id="payerDiv" class="payer-div">
							<table id="payerTable" class="payer-table"></table>
						</div>
					</fieldset>
					<fieldset id="resultField" class="result-field" name="resultField">
						<legend>結果</legend>
						<fieldset id="resultMath" class="result-math" onchange="editPayer();">
							<select name="digit" class="result-digit">
								<option value="1" selected>1円</option>
								<option value="10">10円</option>
								<option value="100">100円</option>
								<option value="1000">1000円</option>
							</select>
							<span>未満</span>
							<input type="radio" id="mathCeil" name="math" value="ceil" checked>
							<label for="mathCeil" class="radio-label">切上げ</label>
							<input type="radio" id="mathRound" name="math" value="round">
							<label for="mathRound" class="radio-label">四捨五入</label>
							<input type="radio" id="mathFloor" name="math" value="floor">
							<label for="mathFloor" class="radio-label">切捨て</label>
						</fieldset>
						<ul id="resultList" class="result-list"></ul>
					</fieldset>
				</form>
				<button id="share" name="share" class="share" onclick="shareResult();">結果を共有する</button>
			</article>
			<aside class="sidebar">
			</aside>
		</main>
		<footer class="footer">
			<nav id="footerNav" class="footer-nav">
				<span>by <a href="https://twitter.com/shutocom0812">@shutocom0812</a></span>
			</nav>
		</footer>
	</body>
	<script>
		let num1 = 0;	//メンバー管理番号用変数
		let num2 = 0;	//費目管理番号用変数
		let members = new Array();	//メンバー
		let items = new Array();	//費目
		let choices = new Object();	//支払者
		let results = new Object(); //結果

		function delRow(target) {	//列の削除
			document.getElementById(`${target.id}Row`).remove();
		}

		function calc(target){	//端数処理
			const digit = document.forms.splitForm.digit.value;
			const times = target / digit;
			let result = 0;
			switch (document.forms.splitForm.math.value) {
				case "floor":
					result = Math.floor(times);
					break;
				case "round":
					result = Math.round(times);
					break;
				case "ceil":
				default:
					result = Math.ceil(times);
			}
			return result * digit;
		}

		function addMember(nowNumber, nowName) {	//メンバー欄の追加
			const MemberRow = document.createElement("div");	//行
			MemberRow.id = nowNumber ? `${nowNumber}Row` : `member${num1}Row`;
			MemberRow.classList.add("row");

			const MemberName = document.createElement("input");	//名前欄
			MemberName.type = "text";
			MemberName.id = nowNumber ? `${nowNumber}Name` : `member${num1}Name`;
			MemberName.name = "memberName";
			MemberName.classList.add("name");
			MemberName.placeholder = "名前";
			MemberName.required = true;
			MemberName.value = nowName ? nowName : "";

			const MemberRmv = document.createElement("button");	//削除ボタン
			MemberRmv.type = "button";
			MemberRmv.id = nowNumber ? `${nowNumber}` : `member${num1}`; //メンバー管理番号の実体
			MemberRmv.classList.add("rmv");
			MemberRmv.tabIndex = -1;
			MemberRmv.addEventListener("click", function(){delRow(this);}, false);

			MemberRow.appendChild(MemberName);	//挿入
			MemberRow.appendChild(MemberRmv);
			document.getElementById("memberForm").appendChild(MemberRow);

			num1++;	//変数を進める
		}

		function addItem(nowNumber, nowName, nowPrice, nowPrePayer) {	//費目欄の追加
			const ItemRow = document.createElement("div");	//行
			ItemRow.id = nowNumber ? `${nowNumber}Row` : `item${num2}Row`;
			ItemRow.classList.add("row");

			const ItemName = document.createElement("input");	//名前欄
			ItemName.type = "text";
			ItemName.id = nowNumber ? `${nowNumber}Name` : `item${num2}Name`;
			ItemName.name = "itemName";
			ItemName.classList.add("name");
			ItemName.placeholder = "費目名";
			ItemName.required = true;
			ItemName.value = nowName ? nowName : "";

			const ItemPrice = document.createElement("input");	//価格欄
			ItemPrice.type = "number";
			ItemPrice.id = nowNumber ? `${nowNumber}Price` : `item${num2}Price`;
			ItemPrice.name = "itemPrice";
			ItemPrice.classList.add("price");
			ItemPrice.step = 1;
			ItemPrice.min = 0;
			ItemPrice.placeholder = "金額";
			ItemPrice.required = true;
			ItemPrice.value = nowPrice ? nowPrice : "";

			const ItemPriceLabel = document.createElement("span");
			ItemPriceLabel.innerText = "円";

			const ItemPrePayer = document.createElement("select");	//立替者欄
			ItemPrePayer.id = nowNumber ? `${nowNumber}PrePayer` : `item${num2}PrePayer`;
			ItemPrePayer.name = "memberList";
			ItemPrePayer.classList.add("select-list");
			ItemPrePayer.required = true;
			ItemPrePayer[0] = new Option("立替者", "");
			ItemPrePayer[0].disabled = true;
			ItemPrePayer[0].hidden = true;
			members.forEach(member => ItemPrePayer.appendChild(new Option(member.name, member.number)));
			ItemPrePayer.value = (nowPrePayer) ? nowPrePayer : "";

			const ItemRmv = document.createElement("button");	//削除ボタンを作成
			ItemRmv.type = "button";
			ItemRmv.id = nowNumber ? `${nowNumber}` : `item${num2}`;	//費目管理番号の実体
			ItemRmv.classList.add("rmv");
			ItemRmv.tabIndex = -1;
			ItemRmv.addEventListener("click", function(){delRow(this);}, false);

			ItemRow.appendChild(ItemName);	//挿入
			ItemRow.appendChild(ItemPrice);
			ItemRow.appendChild(ItemPriceLabel);
			ItemRow.appendChild(ItemPrePayer);
			ItemRow.appendChild(ItemRmv);
			document.getElementById("itemForm").appendChild(ItemRow);

			num2++;	//変数を進める
		}

		function addPayer() {
			const PayerTable = document.getElementById("payerTable");	//支払者編集用のテーブルを取得
			while (PayerTable.firstChild) PayerTable.firstChild.remove();

			const PayerRow1 = PayerTable.insertRow();	//タイトル行
			PayerRow1.appendChild(document.createElement("th"));
			members.forEach(member => {
				const PayerName = document.createElement("th");
				PayerName.innerText = member.name;
				PayerRow1.appendChild(PayerName);
			});

			items.forEach(item => {	//テーブルの中身を作成
				const PayerRow = PayerTable.insertRow();
				const PayerItem = document.createElement("th");
				PayerItem.id = `${item.number}Payers`;
				PayerRow.appendChild(PayerItem);
				members.forEach(member => {
					const PayerCheck = document.createElement("input");
					PayerCheck.type = "checkbox";
					PayerCheck.id = `${item.number}_${member.number}`;
					PayerCheck.name = "payerCheck";
					PayerCheck.classList.add("payer-check");
					PayerCheck.checked = (choices?.[item.number]?.[member.number] == 0) ? false : true;

					const PayerLabel = document.createElement("label");
					PayerLabel.htmlFor = PayerCheck.id;
					PayerLabel.classList.add("payer-label");

					const PayerCell = PayerRow.insertCell();
					PayerCell.appendChild(PayerCheck);
					PayerCell.appendChild(PayerLabel);
				});
			});
			editPayer();
		}

		function editMember() {	//メンバー欄の編集・費目欄の更新
			members = [];	//配列初期化
			for (let i=0; i<num1; i++) {
				if (document.getElementById(`member${i}Name`)?.value) {
					members.push({
						"number": `member${i}`,
						"name": document.getElementById(`member${i}Name`).value.replace(/-|_/g, "ー")
					});
				}
			}

			const MemberLists = document.getElementsByName("memberList");	//メンバー選択肢欄を更新
			MemberLists.forEach(element => {
				const nowValue = element.value;
				while (element.firstChild) element.firstChild.remove();
				element[0] = new Option("立替者", "", true, true);
				element[0].disabled = true;
				element[0].hidden = true;
				members.forEach(member => {
					element.appendChild(new Option(member.name, member.number));
					if (member.number == nowValue) element.value = member.number;
				});
			});
			editItem();
		}

		function editItem() {	//費目欄の編集・支払者欄の更新
			items = [];	//配列初期化
			for (let i=0; i<num2; i++){
				if (document.getElementById(`item${i}Row`)) {
					items.push({
						"number": `item${i}`,
						"name": document.getElementById(`item${i}Name`).value.replace(/-|_/g, "ー") || `費目${i + 1}`,
						"price": document.getElementById(`item${i}Price`).value || 0,
						"prePayer": document.getElementById(`item${i}PrePayer`).value
					});
				}
			}
			addPayer();
		}

		function editPayer() {	//支払者欄の編集・結果欄の更新
			const PayerTable = document.getElementById("payerTable");

			results = {};
			members.forEach(postPayer => {
				let prePayers = {};
				members.forEach(prePayer => prePayers[prePayer.number] = 0);
				results[postPayer.number] = prePayers;
			});

			choices = {};	//配列初期化
			items.forEach(item => {
				let choice = {};
				members.forEach(member => choice[member.number] = document.getElementById(`${item.number}_${member.number}`).checked ? 1 : 0);
				choices[item.number] = choice;
				let headCount = Object.values(choices[item.number]).reduce((sum, i) => sum + i, 0);	//頭数
				let bite = item.price / headCount;	//一口あたり
				members.forEach(postPayer => results[postPayer.number][item.prePayer] += (choices[item.number][postPayer.number] == 1) ? bite : 0);
				document.getElementById(`${item.number}Payers`).innerHTML = `${item.name}<br>(${Math.round(bite * 10) / 10}円)`;
			});

			const ResultList = document.getElementById("resultList");	//結果欄の初期化・追加
			while (ResultList.firstChild) ResultList.firstChild.remove();

			members.forEach(postPayer => {
				let ResultLi = document.createElement("li");
				ResultLi.innerHTML = `<strong>${postPayer.name}</strong>さんは`;
				let ResultUl = document.createElement("ul");
				members.forEach(prePayer => {
					if (prePayer != postPayer && results[postPayer.number][prePayer.number] != 0) {
						let ResultLi2 = document.createElement("li");
						ResultLi2.innerHTML = `<strong>${prePayer.name}</strong>さんに<strong>${calc(results[postPayer.number][prePayer.number])}円</strong>支払ってください。`
						ResultUl.appendChild(ResultLi2);
					}
				});
				
				if (ResultUl.hasChildNodes()) {
					ResultLi.appendChild(ResultUl);
					ResultList.appendChild(ResultLi);
				}
			});
		}

		function shareResult() {
			const params = new URLSearchParams();
			params.append("num1", num1);
			params.append("num2", num2);
			params.append("digit", document.forms.splitForm.digit.value);
			params.append("math", document.forms.splitForm.math.value);

			params.append("members", members.map(member => `${member.number.replace("member", "")}-${member.name}`).join("_"));
			params.append("items", items.map(item => `${item.number.replace("item", "")}-${item.name}-${item.price}-${item.prePayer.replace("member", "")}`).join("_"));
			params.append("choices", Object.values(choices).map(element => Object.values(element).join("")).join("_"));

			let sendURL = `https://${window.location.hostname}${window.location.pathname}?${params}`;

			const shareData = {
				title: "立替精算機",
				url: sendURL,
			}

			if (navigator.share) {
				navigator.share(shareData);
			} else {
				const CopyText = document.createElement("textarea");
				CopyText.id = "copyText";
				CopyText.classList.add("copy-text");
				CopyText.innerText = sendURL;
				CopyText.addEventListener("focus", function() {this.select()});

				const CopyButton = document.createElement("button");
				CopyButton.id = "clipButton";
				CopyButton.classList.add("copy-button");
				CopyButton.innerText = "コピー";
				CopyButton.addEventListener("click", async function copyClip() {
					try {
						await navigator.clipboard.writeText(sendURL);
						runToast("コピーしました");
					} catch (error) {
						runToast("コピーできませんでした");
					}
				});

				runModal(CopyText, CopyButton);
			}
		}

		if (window.location.search) {
			const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());

			document.forms.splitForm.digit.value = params.digit;
			document.forms.splitForm.math.value = params.math;
			params.members.split("_").forEach(key => {
				const element = key.split("-");
				members.push({
					"number": `member${element[0]}`,
					"name": element[1]
				});
			});
			params.items.split("_").forEach(key => {
				const element = key.split("-");
				items.push({
					"number": `item${element[0]}`,
					"name": element[1],
					"price": Number(element[2]),
					"prePayer": element[3] ? `member${element[3]}` : ""
				});
			});

			let paramChoices = new Array();
			params.choices.split("_").forEach(key => paramChoices.push(Array.from(key)));

			items.forEach((item, indexI) => {
				let choice = new Object();
				members.forEach((member, indexM) => choice[member.number] = paramChoices[indexI][indexM]);
				choices[item.number] = choice;
			});

			members.forEach(member => addMember(member.number, member.name));
			items.forEach(item => addItem(item.number, item.name, item.price, item.prePayer));
			num1 = params.num1;
			num2 = params.num2;
			addPayer();
		} else {
			addMember();
			addItem();
		}
	</script>
</html>
