<html>
	<head>
		<title>割り勘計算 | だむめも</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="color-scheme" content="dark light">
		<style>
			:root{
				--white: #E4DAD9;
				--black: #021e1e;
				--color1: #E5996D;
				--color2: #AD4133;
				--color3: #642327;
			}
			@media (prefers-color-scheme: light) {
				:root{
					--back: var(--color1);
				}
			}
			@media (prefers-color-scheme: dark) {
				:root{
					--back: var(--black);
				}
			}
			fieldset{
				all: unset;
				display: block;
				box-sizing: border-box;
			}
			*, ::before, ::after{
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			html{
				background-color: var(--back);
				color: var(--color1);
				font: 16px/2 sans;
				font-weight: bold;
			}
			/*form*/
			/*fieldset*/
			fieldset{
				background-color: var(--color3);
				margin: 4px;
				padding: 8px;
				padding-top: 0;
				border: none;
				border-radius: 4px;
			}
			legend{
				background-color: var(--color3);
				color: var(--color1);
				padding: 4px 8px;
				border-radius: 4px;
			}
			/*input*/
			input[type="number"], input[type="text"]{
				background-color: transparent;
				outline: none;
				color: var(--color1);
				padding: 4px;
				border: 3px solid var(--color1);
				border-radius: 4px;
				appearance: none;
				font: 16px/2 sans;
			}
			input::placeholder{
				color: var(--color1);
				opacity: 0.8;
			}
			input[type="text"]:hover, input[type="number"]:hover, 
			input[type="text"]:focus, input[type="number"]:focus{
				background-color: var(--color2);
				border-color: var(--color2);
				color: var(--color1);
			}
			input[type="text"]:hover::placeholder, input[type="number"]:hover::placeholder, 
			input[type="text"]:focus::placeholder, input[type="number"]:focus::placeholder{
				color: var(--color1);
			}
			::selection{
				background-color: var(--color1);
				color: var(--color3);
			}
			/*button*/
			button{
				background-color: transparent;
				padding: 4px;
				border: 3px solid var(--color1);
				border-radius: 4px;
				outline: none;
				font-weight: bold;
				transition-duration: 0.1s;
			}
			button:hover, button:focus{
				background-color: var(--color1);
				transform: scale(0.9);
			}
			/*select*/
			select{
				background-color: transparent;
				color: var(--color1);
				border: 3px solid var(--color1);
				border-radius: 4px;
				padding: 4px;
				outline: none;
				max-width: 6em;
				text-overflow: ellipsis;
			}
			select:hover, select:focus{
				background-color: var(--color2);
				color: var(--color1);
				border-color: var(--color2);
			}

			/*header*/
			.header{
				background-color: var(--color3);
				padding: 30px 0;
				text-align: center;
			}

			/*article*/
			.main{
				padding: 8px;
			}
			.main-title{
				text-align: center;
				color: var(--color3);
			}

			/*row*/
			.row{
				display: flex;
				padding: 4px;
				align-items: center;
				justify-content: space-between;
			}
			.row *:not(:first-child){
				margin-left: 4px;
			}
			.row input, .row select{
				height: 40px;
			}
			.row input[type="text"]{
				flex-grow: 3;
			}
			.row input[type="number"], .row select{
				flex-grow: 1;
			}

			/*name*/
			.name{
				min-width: 5em;
			}

			/*buttons*/
			.buttons{
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 4px;
			}

			/*button-design*/
			.rmv, .add{
				display: block;
				width: 40px;
				height: 40px;
				position: relative;
				flex-grow: 0;
				flex-shrink: 0;
			}
			.rmv:hover,.add:hover{
				background-color: var(--color2);
				border-color: var(--color2);
			}
			.rmv::before, .add::before, .rmv::after, .add::after{
				content: "";
				position: absolute;
				top: 50%;
				left: 50%;
				width: 3px;
				height: 80%;
				background-color: var(--color1);
				border-radius: 4px;
			}
			.rmv::before{
				transform:  translate(-50%,-50%) rotate(45deg);
			}
			.rmv::after{
				transform: translate(-50%,-50%) rotate(-45deg);
			}
			.add::before{
				transform: translate(-50%,-50%) rotate(180deg);
			}
			.add::after{
				transform: translate(-50%,-50%) rotate(90deg);
			}
			.rmv:hover::before, .add:hover::before, 
			.rmv:hover::after, .add:hover::after, 
			.rmv:focus::before, .add:focus::before, 
			.rmv:focus::after, .add:focus::after{
				background-color: var(--color3);
			}
			.submit{
				background-color: var(--color1);
				color: var(--color3);
				height: 40px;
				padding: 2px 8px;
				text-align: center;
				font-size:16px;
			}
			.submit:hover, .submit:focus{
				background-color: var(--color2);
				color: var(--color1);
				border-color: var(--color2);
			}

			/*input-design*/
			.price{
				width: 4em;
				}

			/*radio*/
			input[type="radio"]{
				width: 0;
				height: 0;
				opacity: 0;
			}
			input[type="radio"] + .radio-label{
				display: inline-block;
				padding: 0 3px;
				border: 3px dashed var(--color1);
				border-radius: 4px;
				color: var(--color1);
			}
			input[type="radio"]:hover + .radio-label, 
			input[type="radio"]:focus + .radio-label{
				border-color: var(--color2);
				color: var(--color2);
			}
			input[type="radio"]:checked + .radio-label{
				background-color: var(--color1);
				border-color: var(--color1);
				color: var(--color3);
			}
			/*payer*/
			.payer-field p{
				padding: 0 4px;
			}
			.payer-div{
				width: 100%;
				overflow: hidden;
				padding: 4px;
				border-radius: 4px;
			}
			#payerTable{
				display: block;
				min-width: 100%;
				padding: 0;
				overflow-x: auto;
			}
			#payerTable th{
				padding: 4px;
				background-color: var(--color1);
				color: var(--color3);
				min-width:5em;
				max-width:8em;
				word-break: break-all;
			}
			#payerTable th:first-child{
				position: sticky;
				left: 0;
				top: 0;
				width: 7em;
				z-index: 10;
				border-left: 1px solid var(--color3);
				border-right: 1px solid var(--color3);
				border-spacing: 0;
			}
			#payeTable th, #payerTable td{
				padding: 8px;
			}
			input[type="checkbox"]{
				width:0;
				height:0;
				opacity:0;
			}
			.payer-box{
				width: 100%;
				display: flex;
				justify-content: center;
			}
			input[type="checkbox"] + .check-label{
				position:relative;
				display: block;
				width: 30px;
				height: 30px;
				background-color: var(--color1);
				border-radius: 4px
			}
			input[type="checkbox"]:checked + .check-label{
				background-color: var(--color2)
			}
			input[type="checkbox"]:checked + .check-label::before {
				content: "";
				display: block;
				position: absolute;
				top: 50%;
				left: 50%;
				width: 40%;
				height: 4px;
				border-radius: 4px;
				transform: translate(-6px, 5px) rotateZ(-135deg);
				transform-origin: 2px 2px;
				background: var(--color1);
			}
			input[type="checkbox"]:checked + .check-label::after {
				content: "";
				display: block;
				position: absolute;
				top: 50%;
				left: 50%;
				width: 76%;
				height: 4px;
				border-radius: 4px;
				transform: translate(-6px, 5px) rotateZ(-45deg);
				transform-origin: 2px 2px;
				background: var(--color1);
			}

			/*result*/
			#resultMath{
				border-bottom: 3px dashed var(--color2);
				border-radius: 0;
			}
			#resultList{
				padding: 4px;
			}
			#resultList, #resultList ul{
				padding-left: 12px;
				list-style-type: none;
			}
		</style>
	</head>
	<body>
		<header class="header">
			<h2>だむめも</h2>
		</header>
		<article class="main">
			<h1 class="main-title">立替計算機</h1>
			<form name="spilit" onsubmit="event.preventDefault();">
				<fieldset name="member">
					<legend>メンバー</legend>
					<div id="memberForm"></div>
					<div class="buttons">
						<button type="button" class="add" name="memberAdd" onclick="addMember();"></button>
						<button type="button" class="submit" name="memberSubmit" onclick="editMember();">決定</button>
					</div>
				</fieldset>
				<fieldset name="item">
					<legend>立替費目</legend>
					<div id="itemForm"></div>
					<div class="buttons">
						<button type="button" class="add" name="itemAdd" onclick="addItem();"></button>
						<button type="button" class="submit" name="itemSubmit" onclick="editItem();">決定</button>
					</div>
				</fieldset>
				<fieldset class="payer-field" name="payer" onchange="editPayer();">
					<legend>支払者</legend>
					<p>それぞれの費目について、割り勘に参加しない人のチェックを外してください。</p>
					<div class="payer-div">
						<table id="payerTable"></table>
					</div>
				</fieldset>
				<fieldset name="result">
					<legend>結果</legend>
					<fieldset id="resultMath" onchange="editPayer();">
						<span>小数点以下</span>
						<input type="radio" id="mathCeil" name="math" value="ceil" checked>
						<label for="mathCeil" class="radio-label">切上げ</label>
						<input type="radio" id="mathRound" name="math" value="round">
						<label for="mathRound" class="radio-label">四捨五入</label>
						<input type="radio" id="mathFloor" name="math" value="floor">
						<label for="mathFloor" class="radio-label">切捨て</label>
					</fieldset>
					<ul id="resultList"></ul>
				</fieldset>
			</form>
		</article>
	</body>
	<script>
		// HTMLElement, HTMLCollection: UpperCamelCase
		// variable: lowerCamelCase

		let num1 = 0;	//メンバー管理番号用変数
		let num2 = 0;	//費目管理番号用変数
		let members = new Array();	//メンバー管理用配列
		let items = new Array();	//費目管理用配列
		let payers = new Object();	//支払関係管理用連想配列

		function delRow(target) {	//列の削除
			document.getElementById(`${target.id}Row`).remove();
		}

		function calc(target){	//端数処理
			const method = document.forms.spilit.math.value;
			switch (method) {
				case "floor":
					return Math.floor(target);
					break;
				case "round":
					return Math.round(target);
					break;
				case "ceil":
				default:
					return Math.ceil(target);
					break;
			}
		}

		function addMember() {	//メンバー追加の関数
			const MemberForm = document.getElementById("memberForm");

			const MemberRow = document.createElement("div");	//行
			MemberRow.id = `member${num1}Row`;
			MemberRow.classList.add("row");

			const MemberName = document.createElement("input");	//名前欄
			MemberName.type = "text";
			MemberName.id = `member${num1}Name`;
			MemberName.classList.add("name");
			MemberName.placeholder = "名前";

			const MemberRmv = document.createElement("button");	//削除ボタン
			MemberRmv.type = "button";
			MemberRmv.id = `member${num1}`; //メンバー管理番号の実体
			MemberRmv.classList.add("rmv");
			MemberRmv.tabIndex = -1;
			MemberRmv.addEventListener("click", function(){delRow(this);}, false);

			MemberRow.appendChild(MemberName);
			MemberRow.appendChild(MemberRmv);
			MemberForm.appendChild(MemberRow);

			num1++;
		}

		function editMember(){	//メンバーを編集する
			members = [];	//配列初期化
			for (let i=0; i<num1; i++) {
				if (document.getElementById(`member${i}Name`).value != "") {
					members.push({
						"number": `member${i}`,
						"name": document.getElementById(`member${i}Name`).value || `メンバー${i}`
					});
				}
			}
			members = members.filter(Boolean);	//空白を詰める

			const MemberLists = document.getElementsByClassName("members-list");	//メンバー選択肢欄を更新
			for (let i=0; i<MemberLists.length; i++){
				const nowValue = MemberLists[i].value;
				while (MemberLists[i].firstChild) {
					MemberLists[i].firstChild.remove();
				}
				MemberLists[i][0] = new Option("立替者", null);
				MemberLists[i][0].hidden = true;
				members.forEach((member, index) => {
					MemberLists[i][index + 1] = new Option(member.name, member.number);
					if (member.number == nowValue) {
						MemberLists[i].value = member.number;
					}
				});
			}
			editItem();
			editPayer();
		}

		function addItem() {	//費目を追加する
			const ItemForm = document.getElementById("itemForm");

			const ItemRow = document.createElement("div");	//行
			ItemRow.id = `item${num2}Row`;
			ItemRow.classList.add("row");

			const ItemName = document.createElement("input");	//名前欄
			ItemName.type = "text";
			ItemName.id = `item${num2}Name`;
			ItemName.classList.add("name");
			ItemName.placeholder = "費目名";

			const ItemPrice = document.createElement("input");	//価格欄
			ItemPrice.type = "number";
			ItemPrice.id = `item${num2}Price`;
			ItemPrice.classList.add("price");
			ItemPrice.step = 1;
			ItemPrice.min = 0;
			ItemPrice.placeholder = "金額";

			const ItemPriceLabel = document.createElement("span");
			ItemPriceLabel.innerText = "円";

			const PrePayer = document.createElement("select");	//立替者欄
			PrePayer.id = `item${num2}PrePayer`;
			PrePayer.classList.add("members-list");
			PrePayer[0] = new Option("立替者", null);	//立替者のデフォルト設定
			PrePayer[0].hidden = true;
			members.forEach((member, index) => PrePayer[index + 1] = new Option(member.name, member.number));

			const ItemRmv = document.createElement("button");	//削除ボタンを作成
			ItemRmv.type = "button";
			ItemRmv.id = `item${num2}`;	//費目管理番号の実体
			ItemRmv.classList.add("rmv");
			ItemRmv.tabIndex = -1;
			ItemRmv.addEventListener("click", function(){delRow(this);}, false);

			ItemRow.appendChild(ItemName);
			ItemRow.appendChild(ItemPrice);
			ItemRow.appendChild(ItemPriceLabel);
			ItemRow.appendChild(PrePayer);
			ItemRow.appendChild(ItemRmv);
			ItemForm.appendChild(ItemRow);

			num2++;
		}

		function editItem() {	//立替費目を編集する
			items = [];	//配列初期化

			for (let i=0; i<num2; i++){
				if (document.getElementById(`item${i}Row`) != null){
					items.push({
						"number": `item${i}`,
						"name": document.getElementById(`item${i}Name`).value || `費目${i}`,
						"price": document.getElementById(`item${i}Price`).value || 0,
						"prePayer": document.getElementById(`item${i}PrePayer`).value
					});
				}
			}

			const PayerTable = document.getElementById("payerTable");	//支払者編集用のテーブルを取得
			const CheckBoxes = document.getElementsByClassName("payer-check");
			const nowValues = {};
			for (let i=0; i<CheckBoxes.length; i++) {
				nowValues[CheckBoxes[i].id] = CheckBoxes[i].checked;	//「itemN_memberN: boolean」
			}

			while (PayerTable.firstChild) {
				PayerTable.firstChild.remove();
			}
			const PayerRow1 = PayerTable.insertRow();	//タイトル行
			const PayerTitle = document.createElement("th");
			PayerTitle.innerText = "費目";
			PayerRow1.appendChild(PayerTitle);
			members.forEach(member => {
				let PayerName = document.createElement("th");
				PayerName.innerText = member.name;
				PayerRow1.appendChild(PayerName);
			});

			items.forEach(item => {	//テーブルの中身を作成
				let PayerRow = PayerTable.insertRow();
				let PayerItem = document.createElement("th");
				PayerItem.innerText = item.name;
				PayerRow.appendChild(PayerItem);
				members.forEach(member => {
					let PayerCell = PayerRow.insertCell();
					let PayerBox = document.createElement("div");
					PayerBox.classList.add("payer-box");
					let PayerCheck = document.createElement("input");
					PayerCheck.type = "checkbox";
					PayerCheck.id = `${item.number}_${member.number}`;
					PayerCheck.classList.add("payer-check");
					PayerCheck.checked = (nowValues[PayerCheck.id] === false) ? false : true;
					let PayerLabel = document.createElement("label");
					PayerLabel.htmlFor = PayerCheck.id;
					PayerLabel.classList.add("check-label");

					PayerBox.appendChild(PayerCheck);
					PayerBox.appendChild(PayerLabel);
					PayerCell.appendChild(PayerBox);
				});
			});

			editPayer();
		}

		function editPayer() {
			const PayerTable = document.getElementById("payerTable");

			payers = {};	//配列初期化
			members.forEach(postPayer => {
				let prePayers = {};
				members.forEach(prePayer => {
					prePayers[prePayer.number] = 0;
					payers[postPayer.number] = prePayers;
				});
			});

			const choices = {};
			items.forEach(item => {
				let choice = {};
				members.forEach(member => {
					choice[member.number] = document.getElementById(`${item.number}_${member.number}`).checked ? 1 : 0;
					choices[item.number] = choice;
				});
				let headCount = Object.values(choices[item.number]).reduce((sum, i) => sum + i, 0);	//頭数
				let price = item.price;	//金額
				let bite = price / headCount;	//一口あたり
				members.forEach(postPayer => {
					payers[postPayer.number][item.prePayer] += (choices[item.number][postPayer.number] === 1) ? bite: 0;
				});
			});

			const ResultList = document.getElementById("resultList");	//結果欄
			while (ResultList.firstChild) {
				ResultList.firstChild.remove();
			}
			members.forEach(postPayer => {
				let ResultLi = document.createElement("li");
				ResultLi.innerText = `${postPayer.name}さんは`;
				let ResultUl = document.createElement("ul");
				members.forEach(prePayer => {
					if (prePayer != postPayer && payers[postPayer.number][prePayer.number] != 0) {
						let ResultLi2 = document.createElement("li");
						ResultLi2.innerText = `${prePayer.name}さんに${calc(payers[postPayer.number][prePayer.number])}円支払ってください。`
						ResultUl.appendChild(ResultLi2);
					}
				});
				ResultLi.appendChild(ResultUl);
				ResultList.appendChild(ResultLi);

				!ResultUl.hasChildNodes() && ResultLi.remove();
			});
		}
		addMember();
		addItem();
	</script>
</html>
